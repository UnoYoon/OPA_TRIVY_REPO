name: Trivy Security Scan  # ì›Œí¬í”Œë¡œ ì´ë¦„

on:
  push:
    branches:
      - main  # main ë¸Œëœì¹˜ì— push ë°œìƒ ì‹œ ì‹¤í–‰
  pull_request:
    branches:
      - main  # main ë¸Œëœì¹˜ ëŒ€ìƒ PR ìƒì„±/ì—…ë°ì´íŠ¸ ì‹œ ì‹¤í–‰

jobs:
  scan:
    runs-on: ubuntu-latest  # GitHub Actionsì—ì„œ ì‚¬ìš©í•  OS í™˜ê²½

    steps:
      - name: Checkout code
        uses: actions/checkout@v3  # í˜„ì¬ ì €ì¥ì†Œì˜ ì½”ë“œë¥¼ ì²´í¬ì•„ì›ƒ (ê°€ì ¸ì˜¤ê¸°)

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2  # Docker Buildx ì„¤ì • (ë©€í‹° í”Œë«í¼ ë¹Œë“œ ì§€ì›)

      - name: Build Docker Image
        run: docker build -t my-app:latest .  # í˜„ì¬ ë””ë ‰í† ë¦¬ ê¸°ì¤€ìœ¼ë¡œ Docker ì´ë¯¸ì§€ ë¹Œë“œ, íƒœê·¸ëŠ” 'my-app:latest'

      - name: Run Trivy via Docker
        run: |
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \  # Docker socket ê³µìœ  (ì´ë¯¸ì§€ ë‚´ë¶€ì—ì„œ Docker ì»¨íŠ¸ë¡¤ ê°€ëŠ¥í•˜ê²Œ)
            -v ${{ github.workspace }}:/workspace \  # ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ê³µìœ  (ê²°ê³¼ íŒŒì¼ ì €ì¥ì„ ìœ„í•´)
            aquasec/trivy:latest \  # ìµœì‹  Trivy ì»¨í…Œì´ë„ˆ ì‚¬ìš©
            image --exit-code 1 --severity CRITICAL,HIGH -f json -o /workspace/result.json my-app:latest  
            # my-app:latest ì´ë¯¸ì§€ ëŒ€ìƒ ì·¨ì•½ì  ìŠ¤ìº”
            # CRITICAL, HIGH ë“±ê¸‰ë§Œ í•„í„°ë§
            # ê²°ê³¼ë¥¼ JSONìœ¼ë¡œ ì¶œë ¥í•˜ì—¬ /workspace/result.json íŒŒì¼ë¡œ ì €ì¥
            # ì·¨ì•½ì  ì¡´ì¬ ì‹œ ì¢…ë£Œì½”ë“œ 1 ë°˜í™˜ â†’ ì´í›„ stepì´ failure() ì¡°ê±´ì—ì„œ ì‹¤í–‰ë¨

      - name: Upload full Trivy result as artifact
        if: failure()  # ì´ì „ stepì—ì„œ ì‹¤íŒ¨í•œ ê²½ìš° (ì¦‰, ì·¨ì•½ì ì´ ë°œê²¬ëœ ê²½ìš°)
        uses: actions/upload-artifact@v4  # Trivy ê²°ê³¼ ì „ì²´ë¥¼ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ (v4 ì‚¬ìš© í•„ìˆ˜)
        with:
          name: trivy-full-report  # ì•„í‹°íŒ©íŠ¸ ì´ë¦„
          path: result.json  # ì—…ë¡œë“œí•  íŒŒì¼ ê²½ë¡œ

      - name: Comment Trivy summary to PR
        if: failure() && github.event_name == 'pull_request'  # ì·¨ì•½ì  ë°œê²¬ + í˜„ì¬ ì´ë²¤íŠ¸ê°€ PRì¼ ê²½ìš°ì—ë§Œ ì‹¤í–‰
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHub API ì¸ì¦ìš© í† í°
        run: |
          PR_NUMBER=$(jq --raw-output .number "$GITHUB_EVENT_PATH")  
          # PR ë²ˆí˜¸ ì¶”ì¶œ (GITHUB_EVENT_PATHì˜ JSONì—ì„œ .number í•„ë“œ ì½ê¸°)

          SUMMARY=$(jq '[.Results[].Vulnerabilities[] | {Target, PkgName, InstalledVersion, VulnerabilityID, Severity}]' result.json)  
          # Trivy ê²°ê³¼ JSONì—ì„œ ì·¨ì•½ì  í•µì‹¬ ì •ë³´ë§Œ ì¶”ì¶œí•˜ì—¬ ìš”ì•½ ë¦¬ìŠ¤íŠ¸ ìƒì„±

          SHORT_SUMMARY=$(echo "$SUMMARY" | jq '.[0:5]')  # ìƒìœ„ 5ê°œ í•­ëª©ë§Œ ë°œì·Œ

          COMMENT="ğŸ” **Trivy scan failed. Found critical/high vulnerabilities:**\n\n\`\`\`json\n$SHORT_SUMMARY\n\`\`\`\nğŸ“ Full report attached as artifact."
          # ì£¼ì„ìœ¼ë¡œ ì‘ì„±í•  ë©”ì‹œì§€ êµ¬ì„± (ë§ˆí¬ë‹¤ìš´ í˜•ì‹)

          curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -X POST \
            -d "{\"body\": \"$COMMENT\"}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${PR_NUMBER}/comments"
          # GitHub APIë¥¼ í†µí•´ í•´ë‹¹ PRì— ìœ„ì—ì„œ ì‘ì„±í•œ COMMENTë¥¼ ì£¼ì„ìœ¼ë¡œ ë“±ë¡
